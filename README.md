# grayout.vim

**grayout.vim** is a vim plugin, that grays out inactive C/C++/Obj-C preprocessor regions using libclang.<br/>
It supports the `compile_commands.json` compilation database, allowing quick and easy project setup.

It was only tested on Linux but should *theoretically* work on other platforms, too.

## Related Work
There are some other plugins providing similar functionality.

* [ifdef highlighting][ifdefhighlighting] adds static vim syntax rules for each *manually* defined macro. It does not make use of a compiler and requires the user to manually specify which macros are defined, thus being rather unflexible and often fails to properly detect skipped regions.

* [DyeVim][DyeVim] integrates with (a custom fork of) [YouCompleteMe][ycm] to retrieve extended syntax information for semantic highlighting, including skipped preprocessor regions.
However, it only works with YCM's libclang completer, not clangd.

* [vim-lsp-inactive-regions][lspregions] integrates with [vim-lsp][vimlsp] and uses the cquery or ccls language server to retrieve skipped preprocessor regions.

* [vim-lsp-cxx-highlight][vimlspcxx] integrates with various LSP plugins and uses the cquery or ccls language server to provide full semantic highlighting, including skipped preprocessor regions.


## Installation

1. Requirements
    * Vim 8.1+ or Neovim
    * Python 3
    * Clang
2. Install the plugin
    * Using a plugin manager
    * Alternatively, copy the contents of this repository to your vim directory
3. Read [Usage](#usage)
4. Read [Configuration](#configuration)
5. ...
6. Profit




## Usage

* Run `:GrayoutUpdate` to parse the current file and apply highlighting.
* Run `:GrayoutClear` to clear all grayout highlights
* Run `:GrayoutClearCache` to clear the compile command cache, forcing to reload all config files when needed.
* Run `:GrayoutShowCommand` to print the current file's compile flags.


## Configuration

### Compile Flags

As with every compiler, clang needs to know your project's compile flags to compile your code.

There are three ways of defining compile flags, that are prioritized in the respective order:

* Compilation Database (**recommended**)

    Instruct your build system to generate a `compile_commands.json` and symlink or move it to your project root.

    A [compilation database][clangdatabase] contains information on how to compile each translation unit. It can be auto-generated by build systems like cmake, or tools like [Bear][bear] or [compdb][compdb].

    For example, using cmake, add this line to your `CMakeLists.txt`:

    ```cmake
    set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
    ```

* `.grayout.conf`

    Create a `.grayout.conf` in your project root containing the compile flags. Linebreaks are ignored.<br/>
    It is recommended to specify `-x <language>` in order to avoid ambiguity, especially with header files.

    ```
    -x c
    -DENABLE_FEATURE_X
    -DANOTHER_FLAG
    -DSOME_CONSTANT=42
    ```

* `g:grayout_default_args`

    The global `g:grayout_default_args` variable holds a list of compile flags and is used when no other configs were found.

    ```vim
    let g:grayout_default_args = [ '-std=c++11', '-DFOOBAR_MACRO' ]
    ```


### Key mappings

The plugin comes with no default keymappings.

To map `:GrayoutUpdate` to e.g. `<F5>` you can add this to your `.vimrc`:

```vim
nnoremap <F5> :GrayoutUpdate<CR>
```

### Options

```vim
" Set default compile flags.
let g:grayout_default_args = []

" Set libclang searchpath. Leave empty for auto-detect.
let g:grayout_libclang_path = ''

" Enable to print debug messages inside vim.
let g:grayout_debug = 0

" Enable to write debug messages to `grayout.log`.
let g:grayout_debug_logfile = 0
```

### Colors

If you don't like the default colors for grayouts, you can change them by altering the `PreprocessorGrayout` style.
By default it links to the `Comment` style.

```vim
highlight PreprocessorGrayout cterm=italic ctermfg=DarkGray gui=italic guifg=#6c6c6c
```


## Todo

* Write vim doc
* Support textprops or nvim_buf_add_highlight
* Fix edge case where consecutive active if/elif/else lines are grayed out when their contents are inactive


[ifdefhighlighting]: http://www.vim.org/scripts/script.php?script_id=7
[ycm]: https://github.com/ycm-core/YouCompleteMe
[DyeVim]: https://github.com/davits/DyeVim
[lspregions]: https://github.com/krzbe/vim-lsp-inactive-regions
[vimlspcxx]: https://github.com/jackguo380/vim-lsp-cxx-highlight
[compdb]: https://github.com/Sarcasm/compdb
[clangdatabase]: http://clang.llvm.org/docs/JSONCompilationDatabase.html
[bear]: https://github.com/rizsotto/Bear
[vimlsp]: https://github.com/prabirshrestha/vim-lsp
